# yaml-language-server: $schema=https://raw.githubusercontent.com/budimanjojo/talhelper/master/pkg/config/schemas/talconfig.json
---
# renovate: depName=ghcr.io/siderolabs/installer datasource=docker
talosVersion: v1.12.4
# renovate: depName=ghcr.io/siderolabs/kubelet datasource=docker
kubernetesVersion: v1.35.1

clusterName: kubernetes
endpoint: https://10.20.0.149:6443

clusterPodNets:
  - "10.42.0.0/16"
clusterSvcNets:
  - "10.43.0.0/16"

additionalApiServerCertSans: &sans
  - &talosControlplaneVip 10.20.0.149
  - 127.0.0.1 # KubePrism
additionalMachineCertSans: *sans

# Disable built-in Flannel to use Cilium
cniConfig:
  name: none

nodes:
  - hostname: "k8s-0"
    ipAddress: "10.20.0.230"
    installDisk: "/dev/sda"
    machineSpec:
      secureboot: false
    schematic: &schematic
      customization:
        extraKernelArgs:
          - -selinux                            # Less security, faster puter
          - apparmor=0                          # Less security, faster puter
          - init_on_alloc=0                     # Less security, faster puter
          - init_on_free=0                      # Less security, faster puter
          - intel_iommu=on                      # PCI Passthrough
          - iommu=pt                            # PCI Passthrough
          - mitigations=off                     # Less security, faster puter
          - security=none                       # Less security, faster puter
          - sysctl.kernel.kexec_load_disabled=1 # Meteor Lake CPU / iGPU
          - talos.auditd.disabled=1             # Less security, faster puter
        systemExtensions:
          officialExtensions:
            - siderolabs/i915
            - siderolabs/intel-ucode
            - siderolabs/mei
            - siderolabs/thunderbolt
    controlPlane: true
    networkInterfaces:
      - interface: bond0
        bond:
          mode: active-backup
          deviceSelectors:
            - hardwareAddr: "88:ae:dd:66:*"
              driver: igc
        dhcp: true
        mtu: 9000
        vip:
          ip: *talosControlplaneVip
        vlans:
          - &vlan30
            vlanId: 30
            mtu: 9000
            dhcp: false
          - &vlan90
            vlanId: 90
            mtu: 9000
            dhcp: false
      - # k8s-0 to k8s-1
        deviceSelector:
          driver: thunderbolt-net
          busPath: "1-1.0"
        addresses:
          - "169.254.255.20/32"
        mtu: 65520
        routes:
          - network: 169.254.255.21/32
            metric: 2048
      - # k8s-0 to k8s-2
        deviceSelector:
          driver: thunderbolt-net
          busPath: "0-1.0"
        addresses:
          - "169.254.255.20/32"
        mtu: 65520
        routes:
          - network: 169.254.255.22/32
            metric: 2048

  - hostname: "k8s-1"
    ipAddress: "10.20.0.229"
    installDisk: "/dev/sda"
    machineSpec:
      secureboot: false
    schematic: *schematic
    controlPlane: true
    networkInterfaces:
      - interface: bond0
        bond:
          mode: active-backup
          deviceSelectors:
            - hardwareAddr: "88:ae:dd:66:*"
              driver: igc
        dhcp: true
        mtu: 9000
        vip:
          ip: *talosControlplaneVip
        vlans:
          - *vlan30
          - *vlan90
      - # k8s-1 to k8s-0
        deviceSelector:
          driver: thunderbolt-net
          busPath: "1-1.0"
        addresses:
          - "169.254.255.21/32"
        mtu: 65520
        routes:
          - network: 169.254.255.20/32
            metric: 2048
      - # k8s-1 to k8s-2
        deviceSelector:
          driver: thunderbolt-net
          busPath: "0-1.0"
        addresses:
          - "169.254.255.21/32"
        mtu: 65520
        routes:
          - network: 169.254.255.22/32
            metric: 2048

  - hostname: "k8s-2"
    ipAddress: "10.20.0.244"
    installDisk: "/dev/sda"
    machineSpec:
      secureboot: false
    schematic: *schematic
    controlPlane: true
    networkInterfaces:
      - interface: bond0
        bond:
          mode: active-backup
          deviceSelectors:
            - hardwareAddr: "88:ae:dd:66:*"
              driver: igc
        dhcp: true
        mtu: 9000
        vip:
          ip: *talosControlplaneVip
        vlans:
          - *vlan30
          - *vlan90
      - # k8s-2 to k8s-0
        deviceSelector:
          driver: thunderbolt-net
          busPath: "1-1.0"
        addresses:
          - "169.254.255.22/32"
        mtu: 65520
        routes:
          - network: 169.254.255.20/32
            metric: 2048
      - # k8s-2 to k8s-1
        deviceSelector:
          driver: thunderbolt-net
          busPath: "0-1.0"
        addresses:
          - "169.254.255.22/32"
        mtu: 65520
        routes:
          - network: 169.254.255.21/32
            metric: 2048

patches:
  - |-  # Enable Talos API access, KubePrism, and host DNS
    machine:
      features:
        kubernetesTalosAPIAccess:
          enabled: true
          allowedRoles: ["os:admin"]
          allowedKubernetesNamespaces: ["system-upgrade"]
        kubePrism:
          enabled: true
          port: 7445
        hostDNS:
          enabled: true
          resolveMemberNames: true
          forwardKubeDNSToHost: false
  - |-  # Configure containerd and NFS mount options
    machine:
      files:
        - op: create
          path: /etc/cri/conf.d/20-customization.part
          content: |-
            [plugins."io.containerd.cri.v1.images"]
              discard_unpacked_layers = false
        - op: overwrite
          path: /etc/nfsmount.conf
          permissions: 420
          content: |
            [ NFSMount_Global_Options ]
            nfsvers=4.2
            hard=True
            nconnect=16
            noatime=True
  - |-  # Disable wiping disk on install
    machine:
      install:
        wipe: false
  - |-  # Load kernel modules for NBD and Thunderbolt
    machine:
      kernel:
        modules:
          - name: nbd
          - name: thunderbolt
          - name: thunderbolt_net
  - |-  # Kubelet node IP subnet and OpenEBS local storage mount
    machine:
      kubelet:
        nodeIP:
          validSubnets:
            - 10.20.0.0/24
        extraMounts:
          - destination: /var/openebs/local
            type: bind
            source: /var/openebs/local
            options: ["bind", "rshared", "rw"]
  - |-  # DNS nameserver and disable search domain
    machine:
      network:
        disableSearchDomain: true
        nameservers:
          - 10.20.0.1
  - |-  # Sysctl tuning for 10Gb/s networking, inotify, hugepages, and user namespaces
    machine:
      sysctls:
        fs.inotify.max_user_watches: 1048576   # Watchdog
        fs.inotify.max_user_instances: 8192    # Watchdog
        net.core.default_qdisc: fq             # 10Gb/s
        net.core.rmem_max: 67108864            # 10Gb/s | Cloudflared / QUIC
        net.core.wmem_max: 67108864            # 10Gb/s | Cloudflared / QUIC
        net.ipv4.tcp_congestion_control: bbr   # 10Gb/s
        net.ipv4.tcp_fastopen: 3               # Send and accept data in the opening SYN packet
        net.ipv4.tcp_mtu_probing: 1            # 10Gb/s | Jumbo frames
        net.ipv4.tcp_rmem: 4096 87380 33554432 # 10Gb/s
        net.ipv4.tcp_wmem: 4096 65536 33554432 # 10Gb/s
        net.ipv4.tcp_window_scaling: 1         # 10Gb/s
        vm.nr_hugepages: 1024                  # PostgreSQL
        user.max_user_namespaces: 11255        # Enable User Namespaces
  - |-  # NTP servers (Cloudflare)
    machine:
      time:
        disabled: false
        servers:
          - 162.159.200.1
          - 162.159.200.123
  - |-  # udev rules for Intel GPU and Thunderbolt auto-authorization
    machine:
      udev:
        rules:
          - # Intel GPU
            SUBSYSTEM=="drm", KERNEL=="renderD*", GROUP="44", MODE="0660"
          - # Thunderbolt
            ACTION=="add", SUBSYSTEM=="thunderbolt", ATTR{authorized}=="0", ATTR{authorized}="1"

# Controller patches
controlPlane:
  patches:
    - |-  # Remove default admission controllers
      cluster:
        apiServer:
          admissionControl:
            $$patch: delete
    - |-  # Cluster config
      cluster:
        allowSchedulingOnControlPlanes: true
        apiServer:
          extraArgs:
            # https://kubernetes.io/docs/tasks/extend-kubernetes/configure-aggregation-layer/
            enable-aggregator-routing: true
        controllerManager:
          extraArgs:
            bind-address: 0.0.0.0
        coreDNS:
          disabled: true
        etcd:
          extraArgs:
            listen-metrics-urls: http://0.0.0.0:2381
          advertisedSubnets:
            - 10.20.0.0/24
        proxy:
          disabled: true
        scheduler:
          extraArgs:
            bind-address: 0.0.0.0

