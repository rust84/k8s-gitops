---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: emqx
  namespace: home
spec:
  interval: 5m
  chart:
    spec:
      chart: emqx
      version: 5.0.16
      sourceRef:
        kind: HelmRepository
        name: emqx-charts
        namespace: flux-system
      interval: 5m
  install:
    createNamespace: true
    remediation:
      retries: 5
  upgrade:
    remediation:
      retries: 5
  values:
    image:
      repository: public.ecr.aws/emqx/emqx
    replicaCount: 3
    recreatePods: true
    ingress:
      dashboard:
        enabled: true
        annotations:
          kubernetes.io/ingress.class: traefik
          kubernetes.io/tls-acme: "true"
          cert-manager.io/cluster-issuer: letsencrypt-prod
          traefik.ingress.kubernetes.io/router.entrypoints: "websecure"
          traefik.ingress.kubernetes.io/router.middlewares: "network-rfc1918@kubernetescrd"
        hosts:
          - emqx.${SECRET_DOMAIN}
        tls:
          - secretName: tls.emqx
            hosts:
              - emqx.${SECRET_DOMAIN}
    persistence:
      enabled: true
      storageClass: rook-ceph-block
      size: 100Mi
    service:
      type: LoadBalancer
      loadBalancerIP: ${SVC_MOSQUITTO_ADDRESS}
    affinity:
      podAntiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                    - emqx
            topologyKey: "kubernetes.io/hostname"
    resources:
      requests:
        cpu: 62m
        memory: 248M
      limits:
        memory: 380M
